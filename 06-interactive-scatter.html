<!DOCTYPE html>
<html>
   <head>
      <script src="https://d3js.org/d3.v7.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.5.3/math.js"></script>
   </head>

   <style>
      #svg-container {
         border-style: solid;
         border-color: black;
         border-width: 2px;
      }

      /* #left-svg {
         border-style: solid;
         border-color: red;
         border-width: 2px;
      }

      #bottom-svg {
         border-style: solid;
         border-color: blue;
         border-width: 2px;
      } */

      #horiz-group {
         display: flex;
         flex-direction: row;
         align-items: center;
      }

      #vert-group {
         display: flex;
         flex-direction: column;
         align-items: right;
      }

      #legend {
         padding-left: 10px;
      }
   </style>
   <body>
      <div>
         <p>Mouse: (<span id="mouse-x"></span>, <span id="mouse-y"></span>)</p>
         <p>Number of dots: <span id="dots-num">0</span></p>
         <div>
            Polynomial degree
            <input type="number" value="1" id="poly-degree"/>
         </div>
         <div>
            Regression line color
            <input type="text" value="blue" id="line-color"/>
            <input type="button" value="Regression" id="regression-btn"/>
         </div>
         <!-- <div>
            Max range
            <input type="text" value="300" id="max-range"/>
            <input type="button" value="Update" id="range-upd-btn"/>
         </div> -->
         <div>
            <input type="button" value="Clear lines" id="clearline-btn"/>
            <input type="button" value="Clear all" id="clearall-btn"/>
         </div>
      </div>

      <div>
         <div id="vert-group">
            <div id="horiz-group">
               <svg id="left-svg"></svg>
               <svg id="svg-container"></svg>
               <div id="legend">
                  <b>Legend</b>
                  <ul></ul>
               </div>
            </div>
            <svg id="bottom-svg"></svg>
         </div>
      </div>

      <script>
         let dots = [];
         let renderSize = 450;
         let dataRange = 300;
         let padding = 30;

         let svg = d3.select('#svg-container')
            .attr('width', renderSize)
            .attr('height', renderSize);
         
         let leftSvg = d3.select('#left-svg')
            .attr('height', renderSize + 20)
            .attr('width', 40);

         let botSvg = d3.select('#bottom-svg')
            .attr('height', 20)
            .attr('width', renderSize + 60);

         // Puts a dot on the screen and save it coords
         function dotClickHandler(e) {
            let [mouseX, mouseY] = d3.pointer(e, svg.node());
            // Remove event listener
            currentDot.on('click', function(){});
            // Change color
            currentDot.attr('fill', 'green');
            currentDot.attr('class', 'static-point')
            // Create a new dot to follow the cursor
            currentDot = createDot();
            // Save the coordinate
            dots = [...dots, [dataScale(mouseX), dataScale(mouseY)]];
            // Update count
            d3.select('#dots-num').text(dots.length);
         }

         // Create a new moving dot
         function createDot() {
            let dot = svg.append('circle')
            .attr('id', 'dot')
            .attr('r', 4)
            .attr('cx', 0)
            .attr('cy', 0)
            .attr('fill', 'red');
            dot.on('click', dotClickHandler);
            return dot;
         }

         // Initialize first dot
         let currentDot = createDot();

         // Initialize axes
         let xAxisScale = d3.scaleLinear().domain([0, dataRange]).range([0, renderSize]);
         let yAxisScale = d3.scaleLinear().domain([0, dataRange]).range([renderSize, 0]);

         let dataScale = d3.scaleLinear().domain([0, renderSize]).range([0, dataRange]);

         leftSvg.append('g')
            .attr('transform', 'translate(30, 10)')
            .call(d3.axisLeft(yAxisScale));
         
         botSvg.append('g')
            .attr('transform', 'translate(45, 0)')
            .call(d3.axisBottom(xAxisScale));

         // Event listener to make the dot follow the mouse
         svg.on('mousemove', function(e) {
               let [mouseX, mouseY] = d3.pointer(e, svg.node());
               // console.log(mouseX, mouseY);
               
               currentDot.attr('cx', mouseX);
               currentDot.attr('cy', mouseY);
               d3.select('#mouse-x').text(Math.round(dataScale(mouseX)));
               d3.select('#mouse-y').text(Math.round(dataScale(renderSize - mouseY)));
         });

         // Event listener to do regression
         d3.select('#regression-btn').on('click', function() {
            // Get polynomial degree
            let degree = d3.select('#poly-degree').node().value;

            // Extract x and y features
            let x = dots.map((d) => d[0]);
            let y = dots.map((d) => d[1]);
            
            // Create vertical vector y
            y = math.matrix(y).reshape([-1, 1]);
            
            // Create features for matrix X
            function polyFeatures(x, degree) {
               let X = [math.ones(x.length)._data];
               for (let i = 1; i <= degree; i++) {
                  X = [...X, math.dotPow(x, i)];
               }
               X = math.transpose(math.matrix(X));
               return X;
            }

            let X = polyFeatures(x, degree);

            // Fit model 
            let theta = math.multiply(math.pinv(X), y);
            
            // Create test data
            let t = math.range(0, dataRange, 1)._data;
            let T = polyFeatures(t, degree);
            // Predict
            let yhat = math.flatten(math.multiply(T, theta))._data;
            // console.log(yhat);

            // Plot curve
            let lineColor = d3.select('#line-color').node().value;

            for (let i = 1; i < yhat.length; i++) {
               svg.append('line')
                  .transition()
                  .ease(d3.easeCubic)
                  .duration(500)
                  .attr('x1', xAxisScale(t[i - 1]))
                  .attr('y1', xAxisScale(yhat[i - 1]))
                  .attr('x2', xAxisScale(t[i]))
                  .attr('y2', xAxisScale(yhat[i]))
                  .style('stroke', lineColor)
                  .style('stroke-width', 2)
                  .attr('class', 'regline');

            }

            d3.select('#legend').select('ul')
               .append('li')
               .attr('class', 'legend-li')
               .text(`${lineColor}: degree ${degree}`)
               .style('color', lineColor);
         });

         function clearLines() {
            d3.selectAll('.regline')
               .remove();
            d3.selectAll('.legend-li')
               .transition()
               .remove();
         }

         function clearPoints() {
            d3.selectAll('.static-point')
               .transition()
               .duration(500)
               .ease(d3.easeCubic)
               .remove();
         }

         // Callback for clear all
         d3.select('#clearall-btn').on('click', function() {
            clearPoints();
            clearLines();
         });

         // Callback for clear line
         d3.select('#clearline-btn').on('click', function() {
            clearLines();
         });
      </script>
   </body>
</html>
